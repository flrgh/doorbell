worker_processes 1;

pcre_jit on;


error_log  logs/error.log debug;
pid        logs/nginx.pid;


events {
    worker_connections  1024;
}

http {
    default_type  application/octet-stream;

    resolver 8.8.8.8 ipv6=off;

    lua_shared_dict doorbell   5m;
    lua_shared_dict rules      32m;
    lua_shared_dict rules_hash 8m;
    lua_shared_dict metrics    16m;
    lua_shared_dict stats      8m;
    lua_shared_dict locks      1m;

    lua_package_path "/home/michaelm/git/doorbell/lib/?.lua;/home/michaelm/git/lua-resty-pushover/lib/?.lua;;";

    # Don't reveal OpenResty version to clients.
    server_tokens off;


    init_by_lua_block {
        require("doorbell").init({
            base_url = os.getenv("DOORBELL_BASE_URL"),
            save_path = os.getenv("DOORBELL_SAVE_PATH"),
            log_path  = os.getenv("DOORBELL_LOG_PATH"),
            geoip_db = os.getenv("DOORBELL_GEOIP_DATABASE"),
            trusted = {
                "127.0.0.0/8",
                "10.0.0.1/16",
            },
            notify = {
                strategy = "spec.fixtures.notify",
                config = {},
            },
        })
    }

    init_worker_by_lua_block {
        require("doorbell").init_worker()
    }

    server {
        listen 9876;

        content_by_lua_block {
            require("doorbell").ring()
        }

        log_by_lua_block {
            require("doorbell").log()
        }
    }
}
